stages:
  - tools
  - knitr
  - exports
  - pdf
  
variables:
  TEX_DIR: "Paper"
  KNITR_OUTPUT_DIR: "knitr"
  OVERLEAF_ARTIFACTS_DIR: "overleaf"
  COMPOSE_FILES: --file docker-compose.yml --file docker-compose-gitlab.yml
  
.docker:
  tags:
      - docker
  services:
      - docker:18.09.7-dind
  variables:
      DOCKER_HOST: tcp://docker:2375/
      DOCKER_DRIVER: overlay2
      DOCKER_TLS_CERTDIR: ""
  image: ${CI_REGISTRY}/ci-utilities/ci-commands/gitlab-docker-compose-ci

tools:
  stage: tools
  extends: 
    - .docker
  script:
    - gitlab-docker-compose ${COMPOSE_FILES} --cache-from main paper-tools

knitr:
  stage: knitr
  extends: 
    - .docker
  tags:
    - docker-mem:3
  script:
    - docker login --username "${CI_REGISTRY_USER}" --password "${CI_REGISTRY_PASSWORD}" "${CI_REGISTRY}"
    - mv "${TEX_DIR}/cache" cache
    - docker-compose ${COMPOSE_FILES} run paper-knit
  cache:
    key: knitr
    paths:
      - ${TEX_DIR}/cache
      - cache
  artifacts:
    name: "${CI_PROJECT_NAME}-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}-knitr"
    paths:
      - "${KNITR_OUTPUT_DIR}"

overleaf:
  extends: .docker
  stage: exports
  script:
    - mkdir "${OVERLEAF_ARTIFACTS_DIR}"
    - cp -r "${KNITR_OUTPUT_DIR}/RSVOptimization.tex" "${TEX_DIR}/structure.tex" "${TEX_DIR}/RSVOptimization.bib" "${KNITR_OUTPUT_DIR}/figures" "${OVERLEAF_ARTIFACTS_DIR}"
  artifacts:
    name: "${CI_PROJECT_NAME}-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}-overleaf"
    paths:
      - "${OVERLEAF_ARTIFACTS_DIR}"

pdf:
  stage: pdf
  extends: 
    - .docker
  script:
    - docker login --username "${CI_REGISTRY_USER}" --password "${CI_REGISTRY_PASSWORD}" "${CI_REGISTRY}"
    - docker-compose ${COMPOSE_FILES} run paper-pdf
    - mv "${OVERLEAF_ARTIFACTS_DIR}/RSVOptimization.pdf" .
  artifacts:
    name: "${CI_PROJECT_NAME}-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}-pdf"
    paths:
      - "RSVOptimization.pdf"
